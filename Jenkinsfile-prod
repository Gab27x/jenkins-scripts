pipeline {
    agent any

    tools {
        maven 'Maven'
        jdk 'Java11'
    }

    environment {
        GIT_REPO = 'https://github.com/Gab27x/ecommerce-microservice-backend-app.git'
        BRANCH = 'master'
        DOCKER_REPO = 'gab27x/microservices'
\
    
    }

    stages {
        stage('CLONE') {
                    steps {
                        deleteDir()
                        sh "git clone -b ${BRANCH} ${GIT_REPO} ."
                    }
                }

       
        stage('Minikube Setup & Deployment') {
            steps { // <-- INICIO DEL BLOQUE 'steps' de la etapa Minikube
                script {
                    echo "============================="
                    echo "Starting Minikube "
                    echo "============================="

                    // 1. Iniciar Minikube
                    echo "Starting Minikube..."
                    sh "minikube start --cpus 4 --memory 8192"
                    
                    
                }
            } // <-- FIN DEL BLOQUE 'steps' de la etapa Minikube
        } // <-- FIN DE LA ETAPA 'Minikube Setup & Deployment'

        stage('Minikube Deployment and e2e tests') {
            steps { // <-- INICIO DEL BLOQUE 'steps' de la etapa Minikube
                script {
                   
                    echo "Deploying microservices via Helm..."
                    sh "helm upgrade --install microservices-prod ./microservices -f ./microservices/values-prod.yaml --namespace prod --create-namespace"
                    

                    sh "sleep 40"

                    // 3. Verificación
                    echo "Verifying deployment status..."
                    sh "kubectl get pods -n stage"
                }
            } // <-- FIN DEL BLOQUE 'steps' de la etapa Minikube
        } // <-- FIN DE LA ETAPA 'Minikube Setup & Deployment'







    }



    post {
        always {
            echo '=== Limpiando entorno ==='


            // --- LIMPIEZA DE MINIKUBE ---
            echo "Limpiando el clúster Minikube..."
            sh "minikube delete"
            
            // Limpiar el workspace de Jenkins
            cleanWs()
            echo '=== Workspace limpiado ==='
        }

        success {
            echo 'Pipeline completado con éxito.'
        }

        failure {
            echo 'El pipeline falló. Revisa los logs para más detalles.'
        }
    }

}
