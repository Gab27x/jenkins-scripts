pipeline {
    agent any

    tools {
        maven 'Maven'
        jdk 'Java11'
    }

    environment {
        GIT_REPO = 'https://github.com/Gab27x/ecommerce-microservice-backend-app.git'
        BRANCH = 'master'
        DOCKER_REPO = 'gab27x/microservices'
    }



    stages {

        stage('CLONE') {
            steps {
                deleteDir()
                sh "git clone -b ${BRANCH} ${GIT_REPO} ."
            }
        }

        stage('Minikube Setup & Deployment') {
            steps {
                script {
                    echo "============================="
                    echo "Starting Minikube"
                    echo "============================="

                    sh "minikube start --cpus 4 --memory 8192"
                }
            }
        }

        stage('Minikube Deployment and tests') {
            steps {
                script {
                        echo "============================="
                        echo "Deploying microservices via Helm"
                        echo "============================="
                   
                    // Instala con Helm
                    sh "helm install microservices-prod ./microservices -f ./microservices/values-prod.yaml --namespace prod --create-namespace"

                    echo "Waiting for pods to be ready..."
                    // Espera a que todos los pods (microservicios) estén en estado Running
                    sh '''
                        kubectl wait --for=condition=available deployment --all -n prod --timeout=300s || true
                        kubectl get pods -n prod
                    '''

                    echo "Waiting for test jobs (Locust and API Tests) to complete..."
                    // Espera hasta que los jobs terminen (máx 10 minutos)
                    timeout(time: 10, unit: 'MINUTES') {
                        waitUntil {
                            def locustStatus = sh(script: "kubectl get job -n prod microservices-prod-locust-job -o jsonpath='{.status.succeeded}' || echo 0", returnStdout: true).trim()
                            def apiStatus = sh(script: "kubectl get jobs -n prod -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\\n' | grep microservices-prod-api-tests | xargs -I{} kubectl get job -n prod {} -o jsonpath='{.status.succeeded}' || echo 0", returnStdout: true).trim()
                            return (locustStatus == '1' && apiStatus == '1')
                        }
                    }

                    echo "All Jobs completed successfully."
                        }
            }
        }
        stage('Show relase notes'){

            steps{
                     script {
            echo '=== Helm Release Notes ==='
            sh 'helm get notes microservices-prod -n prod'

            echo '=== Locust Job Logs ==='
            sh '''
                kubectl logs -n prod $(
                    kubectl get pods -n prod \
                    -l job-name=microservices-prod-locust-job \
                    --sort-by=.metadata.creationTimestamp \
                    -o jsonpath='{.items[-1:].metadata.name}'
                )
            '''

            echo '=== API Tests Job Logs ==='
            sh '''
                kubectl logs -n prod $(
                    kubectl get pods -n prod \
                    -l job-name=$(
                        kubectl get jobs -n prod -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\\n' | grep microservices-prod-api-tests | head -n1
                    ) \
                    -o jsonpath='{.items[0].metadata.name}'
                )
            '''
        }
            }
        }
    }

    post {
        always {
            echo '=== Limpiando entorno ==='
            sh 'kubectl get pods -n prod'
            sh "minikube delete"
            cleanWs()
            echo '=== Workspace limpiado ==='
        }

        success {
            echo 'Pipeline completado con éxito.'


        }

        failure {
            echo 'El pipeline falló. Revisa los logs para más detalles.'
        }
    }
}
